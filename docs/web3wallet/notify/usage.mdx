import Container from '../../components/Container'
import Tabs from '@theme/Tabs'
import TabItem from '@theme/TabItem'
import PlatformTabs from '../../components/PlatformTabs'
import PlatformTabItem from '../../components/PlatformTabItem'
import Wrapper from '../../components/Home/Wrapper'
import CloudBanner from '../../components/CloudBanner'

# Usage

This usage step is to configure and use Notify in your project.

<CloudBanner />

## Client Configuration

<PlatformTabs
	groupId="w3w"
	activeOptions={["ios","android", "react-native"]}
>
<PlatformTabItem value="ios">

Configure the `Notify` instance with:

```swift
try Notify.configure(groupIdentifier: String, environment: APNSEnvironment, crypto: CryptoProvider)
```

`groupIdentifier` - identifier of your group keychain, enables to share keychain items between your wallet and a UNNotificationServiceExtension that decrupts remote Push Notifications.

`environment` - Use `debug` environment for debug builds and `release` for release and TestFlight builds

`crypto` - CruptoProvider is a protocol, you are required to provide an implementation of two methods recoverPubKey and keccak256.


#### Register an identity key and enable cross-device account syncing

:::note
This is a one-time action that does not need to be repeated after initial registration of the new account.
:::

To register an identity key, you must provide a callback to the ` onSign: @escaping SigningCallback` parameter of the `register` method.
In order to register identity keys and enable cross device sync, the SDK will trigger this callback with a messages to sign, expecting the signature for that message to be returned.

```swift
Notify.instance.register(account: account, domain: domain, onSign: onSign)
```

`account` - An account that the identity key will be issued for

`domain` - A domain of your wallet, you should use your bundle id

`onSign` - callback that requres a signature from a user


```swift
func onSign(message: String) -> SigningResult {

    // Provide your own sing function implementation that returns CacaoSignature
    // For more detailed example see our sample WalletApp
    let signature = try! signer.sign(message: message)
    return .signed(signature)
}
```

</PlatformTabItem>
<PlatformTabItem value="android">

To initialize the Web3Inbox client, create a `Inbox.Params.Init` object in the Android Application class with the Core Client. The `Inbox.Params.Init` object will then be passed to the `Web3Inbox` initialize function.

```kotlin
val accountsPrivateKey: ByteArray = /* address' private key. */
val caip10Account: String = /*[CAIP-10](https://github.com/ChainAgnostic/CAIPs/blob/master/CAIPs/caip-10.md) compatible accountId*/
val projectId = PROJECT_ID
val relayUrl = "relay.walletconnect.com"
val serverUrl = "wss://$relayUrl?projectId=${projectId}"
val appMetaData = Core.Model.AppMetaData(
    name = "Kotlin.Web3Inbox",
    description = "Kotlin Web3Inbox Implementation",
    url = "kotlin.web3inbox.walletconnect.com",
    icons = listOf("https://raw.githubusercontent.com/WalletConnect/walletconnect-assets/master/Icon/Gradient/Icon.png"),
    redirect = null
)

CoreClient.initialize(relayServerUrl = serverUrl, connectionType = ConnectionType.AUTOMATIC, application = this, metaData = appMetaData)

Web3Inbox.initialize(Inbox.Params.Init(core = CoreClient, account = Inbox.Type.AccountId(caip10Account), onSign = { message ->
    // Message to be signed by the user.
    //    If user decides to sign the message, use the CacaoSigner util class to sign the message.
    //    If user decides to not sign the message, return null
    return CacaoSigner.sign(message, accountsPrivateKey, SignatureType.EIP191) OR null
    }
)) { error ->
    // Error will be thrown if there's an issue during initialization
}
```

</PlatformTabItem>
<PlatformTabItem value="react-native">

All clients will be initialized as soon as the Web3Inbox component is rendered for the first time.

</PlatformTabItem>
</PlatformTabs>

## SDK Usage

<PlatformTabs
	groupId="w3w"
	activeOptions={["ios","android", "react-native"]}
>
<PlatformTabItem value="ios">

# Subscribe Events

#### Subscribe Notify Message

Emits new notify message from a dapp.

```swift
public var notifyMessagePublisher: AnyPublisher<PushMessage, Never>
```

#### Subscribe Active Subscriptions

Emits a list of active subscriptions.

```swift
public var subscriptionsPublisher: AnyPublisher<[PushSubscription], Never>
```

#### Create Notify Subscription

To enable seamless communication between a Dapp and a wallet, the wallet must first establish a Notify Subscription. This crucial step allows the Dapp and its associated services to publish notify messages directly to the wallet. Upon granting permission for the wallet's iOS application to display Push Notifications, users will experience real-time updates in the form of push notifications on their devices. For an enhanced user experience, consider subscribing to the `notifyMessagePublisher` channel. This option ensures that notify messages are delivered promptly when the app is active and a web socket connection is established, keeping users informed and engaged.

To subscribe to dapp's notify messages first fetch publicly discoverable dapps with WalletConnet explorer:

https://explorer-api.walletconnect.com/v3/dapps?projectId={your_project_id}&is_notify_enabled=true

and request a subscription directly from the wallet.

You can also subscribe on web3inbox.com, the subscription will be synced accross devices and will appear in the wallet.

```swift
public func subscribe(appDomain: String, account: Account) async throws {
```

`appDomain` - A domain of the dapp that you want to subscribe to

`account` - an account you want to associate the subscription with


#### Get Active Subscriptions

```swift
Notify.instance.getActiveSubscriptions()
```

#### Delete Subscription

To delete a subscription.

```swift
try await Notify.instance.deleteSubscription(topic: String)
```

#### Get Notify Messages

To get messages by topic call:

```swift
Notify.instance.getMessageHistory(topic: subscription.topic)
```


</PlatformTabItem>
<PlatformTabItem value="android">

Once the Web3Inbox client is [initialized](#client-configuration), all that's left to do is to place the `Web3Inbox.View` in your app.
We support both [Compose](https://developer.android.com/jetpack/compose), which sample sample implementation can be found in
our [sample app](https://github.com/WalletConnect/WalletConnectKotlinV2/blob/develop/samples/web3wallet/src/main/android/com/walletconnect/web3/wallet/ui/routes/composable_routes/web3inbox/Web3InboxRoute.kt)

#### Composable Web3Inbox.View()

To remember Web3Inbox state call `Web3Inbox.rememberWeb3InboxState()` which later needs to be passed to
`Web3Inbox.View(state)` composable.To display Web3Inbox with Compose call `Web3Inbox.View(state)` somewhere in your app.

```kotlin
   setContent {
        val state = Web3Inbox.rememberWeb3InboxState()
        Web3Inbox.View(state = state)
   }
```

#### Android XML

Adding Web3Inbox to legacy Views should be achieved according to Google's guidelines:
https://developer.android.com/jetpack/compose/migrate/interoperability-apis/compose-in-views.

#### Prevent reloading of Web3Inbox

**IMPORTANT:** If Web3Inbox's inner WebView is reloaded it will lose state and be displayed as blank page.
To prevent reloading of Web3Inbox the activity that contains the `Web3Inbox.View` add
`android:configChanges="orientation|screenSize"` to `<activity>` element `Manifest.xml` that houses Web3Inbox.

</PlatformTabItem>

<PlatformTabItem value="react-native">

This example makes use of [WalletConnect Modal](/2.0/advanced/walletconnectmodal/about?platform=react-native) for simplicity but you can also integrate Web3Inbox into your React Native Wallet by providing the following props.

For more context, feel free to check our [example](https://github.com/WalletConnect/react-native-examples/tree/web3inbox-dapp/dapps/web3inbox).

```tsx
import { Web3Inbox } from '@walletconnect/web3inbox-webview'
import { useCallback, useState } from 'react'

export default function Example() {
  const { provider, isConnected, address } = useWalletConnectModal()
  const [isVisible, setIsVisible] = useState(true)

  const toggleWeb3InboxModal = useCallback(
    () => setIsVisible(isCurrentlyVisible => !isCurrentlyVisible),
    []
  )

  const handleSign = useCallback(
    async (message: string) => {
      const response = await provider?.request(
        {
          method: 'personal_sign',
          params: [message, address]
        },
        'eip155:1'
      )
      return response as string
    },
    [provider, address]
  )

  const clientMetadata = {
    name: 'Web3Inbox React Native Example',
    description: 'An example app to showcase how to use Web3Inbox React Native SDK',
    url: 'https://github.com/WalletConnect/web3inbox-js-sdk',
    icons: ['https://avatars.githubusercontent.com/u/37784886']
  }

  return (
    <View>
      <Web3Inbox
        projectId={projectId}
        ethAddress={address}
        onSign={handleSign}
        visible={isVisible}
        setVisible={toggleWeb3InboxModal}
        clientMetadata={clientMetadata}
      />
    </View>
  )
}
```

#### Required Props

#### projectId `string`

Get your project ID key on [WalletConnect Cloud](https://cloud.walletconnect.com).

#### ethAddress `string`

Ethereum wallet address of the current user.

#### onSign `(message: string) => Promise<string>`

Web3Inbox client will request user to sign messages with its account private key. The message may be a Sync Storage derivation key or Identity key registration.

#### clientMetadata

Web3Inbox will consume your metadata for various use cases, such as displaying your logo and the name of your project.

```ts
interface IClientMetadata {
  name: string
  description: string
  url: string
  icons: string[]
}
```

#### visible `boolean`

Determines visibility of Web3Inbox webview.

#### setVisible `() => void`

Function to set `visible` prop to true or false.

#### Optional Props

#### closeButton `React.ReactNode`

Provide a custom component to close Web3Inbox webview.

#### chatEnabled `boolean`

Enable or disable Chat SDK in Web3Inbox (default: `true`), setting it to `false` will also remove the navigation item.

#### notifyEnabled `boolean`

Enable or disable Notify SDK in Web3Inbox (default: `true`), setting it to `false` will also remove the navigation item.

#### settingsEnabled `boolean`

Enable or disable settigns page in Web3Inbox (default: `true`), setting it to `false` will also remove the navigation item.

</PlatformTabItem>
</PlatformTabs>

## Push Notification

<PlatformTabs
	groupId="w3w"
	activeOptions={["ios","android", "react-native"]}
>
<PlatformTabItem value="ios">

#### Configure your project to enable Push Notifications

[Configure Project](../../advanced/echo-server.md)

#### Register for Push Notifications

In order to enable Push Notifications for your app you need to follow standard procedure:

[Enable Push Notifications Capability](https://developer.apple.com/documentation/usernotifications/registering_your_app_with_apns#2980170)

Ask for user permissions:

call registerForPushNotifications() early in your app's lifecycle to initiate the registration process with Apple Push Notification service:

```swift
    func registerForPushNotifications() {
        UNUserNotificationCenter.current()
            .requestAuthorization(
                options: [.alert, .sound, .badge]
            ) { granted, error in
                guard granted else { return }
                DispatchQueue.main.async {
                    UIApplication.shared.registerForRemoteNotifications()
                }
            }
    }
```

Receive token from Apple Push Notification Services and register it at the Push Server:

```swift
    func application(
      _ application: UIApplication,
      didRegisterForRemoteNotificationsWithDeviceToken deviceToken: Data
    ) {
        Task(priority: .high) {
            try await Notify.instance.register(deviceToken: deviceToken)
        }
    }
```

#### Decrypting Push Notifications

Push notifications sent via APNs are encrypted and carry the following payload:

```
{
  "aps":{
    "content-available":1,
    "mutable-content":1
  },
    "ciphertext":"encrypted-payload",
    "topic":"subscription_topic",
}
```

To decrypt a Push Notification (PN), you need to instantiate a [UNNotificationServiceExtension](https://developer.apple.com/documentation/usernotifications/unnotificationserviceextension).

For details on how to modify the content in newly delivered notifications, refer to the official Apple Developer Documentation [here](https://developer.apple.com/documentation/usernotifications/modifying_content_in_newly_delivered_notifications).

Additionally, you will need to create a [keychain group](https://developer.apple.com/documentation/security/keychain_services/keychain_items/sharing_access_to_keychain_items_among_a_collection_of_apps) that is shared between your wallet application and the notification service. 

Inside your notification service extension file, import WalletConnectNotify, initialize `NotifyDecryptionService()`, and decrypt the message with the following Swift code:

```swift
override func didReceive(_ request: UNNotificationRequest, withContentHandler contentHandler: @escaping (UNNotificationContent) -> Void) {
    bestAttemptContent = (request.content.mutableCopy() as? UNMutableNotificationContent)
    if let bestAttemptContent = bestAttemptContent {
        let topic = bestAttemptContent.userInfo["topic"] as! String
        let ciphertext = bestAttemptContent.userInfo["blob"] as! String
        do {
            let service = NotifyDecryptionService(groupIdentifier: "your_keychain_group_identifier")
            let pushMessage = try service.decryptMessage(topic: topic, ciphertext: ciphertext)
            bestAttemptContent.title = pushMessage.title
            bestAttemptContent.body = pushMessage.body
            contentHandler(bestAttemptContent)
            return
        }
    ...
}
```

</PlatformTabItem>
<PlatformTabItem value="android">

Currently Web3Inbox SDK contains Chat SDK features. Push SDK features coming soon.

</PlatformTabItem>
<PlatformTabItem value="react-native">

Currently Web3Inbox SDK contains Chat SDK features. Notify SDK features coming soon.

</PlatformTabItem>
</PlatformTabs>
